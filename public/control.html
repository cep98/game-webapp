<script>
  const socket = io();
  socket.on("connect", () => {
    socket.emit("identify", { role:"control", deviceId: socket.id });
  });

  const btn = document.getElementById("laserBtn");
  let drawing = false, zeroA = null, zeroB = null, permRequested = false;
  let lastAlpha = 0, lastBeta = 0;

  // DeviceOrientation‑Listener immer schon registrieren
  window.addEventListener("deviceorientation", ev => {
    lastAlpha = ev.alpha; 
    lastBeta  = ev.beta;
    if (!drawing || zeroA === null) return;
    // ... deine bestehende draw‑Logik hier ...
    let dA = lastAlpha - zeroA;
    if (dA > 180) dA -= 360;
    if (dA < -180) dA += 360;
    let dB = lastBeta - zeroB;
    dA = Math.max(-20, Math.min(20, dA));
    dB = Math.max(-20, Math.min(20, dB));
    const x = (dA + 20)/40;
    const y = 1 - ((dB + 20)/40);
    socket.emit("draw", { x, y, deviceId: socket.id });
  });

  btn.addEventListener("touchstart", async e => {
    e.preventDefault();
    // nur einmalig die Permission anfragen
    if (!permRequested && DeviceOrientationEvent?.requestPermission) {
      permRequested = true;
      try {
        const state = await DeviceOrientationEvent.requestPermission();
        if (state !== "granted") {
          alert("Gyroskop‑Zugriff verweigert – ohne ihn kann kein Laserpunkt gesendet werden.");
          return;
        }
      } catch(err) {
        console.warn("Permission‑Request fehlgeschlagen:", err);
        return;
      }
    }
    // erst nach erfolgreicher Freigabe zeichnen
    drawing = true;
    zeroA   = lastAlpha;
    zeroB   = lastBeta;
  }, { passive: false });

  btn.addEventListener("touchend", e => {
    e.preventDefault();
    drawing = false;
  }, { passive: false });
</script>
