<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin-Panel</title>
  <style>
    body { margin:0; background:#111; color:#fff; font-family:sans-serif; }
    header, section { padding:1em; }
    header { display:flex; align-items:center; justify-content:space-between; background:#222; }
    #version { font-size:0.9em; opacity:0.7; }
    #settings { display:flex; gap:1em; align-items:center; }
    #clients, #gyrolog { list-style:none; padding:0; margin:1em; }
    #clients li, #gyrolog li { padding:0.5em; border-bottom:1px solid #333; display:flex; justify-content:space-between; }
    .dot { width:12px; height:12px; border-radius:50%; margin-right:0.75em; flex-shrink:0; background:#666; }
    .left { display:flex; align-items:center; }
    .client-info { font-size:0.95em; }
    .gyro-values { font-family:monospace; font-size:0.85em; color:#afa; }
  </style>
</head>
<body>
  <header>
    <h1>Admin-Panel</h1>
    <div id="version">v1.7 Admin</div>
    <div id="settings">
      <label>Max. Winkel H:<input id="maxHor" type="number" value="20" /></label>
      <label>Max. Winkel V:<input id="maxVer" type="number" value="20" /></label>
      <label>Glättung:<input id="smoothing" type="range" value="50" /><span id="smoothingVal">50%</span></label>
    </div>
  </header>

  <section>
    <h2>Angeschlossene Clients</h2>
    <ul id="clients"></ul>
  </section>

  <section>
    <h2>Gyro‑Log (α, β, γ)</h2>
    <ul id="gyrolog"></ul>
  </section>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    // Settings-UI …
    const maxHor = document.getElementById('maxHor'),
          maxVer = document.getElementById('maxVer'),
          smoothing = document.getElementById('smoothing'),
          smoothingVal = document.getElementById('smoothingVal');
    function sendSettings() {
      socket.emit('update-settings', {
        maxHor: parseFloat(maxHor.value),
        maxVer: parseFloat(maxVer.value),
        smoothing: parseFloat(smoothing.value)/100
      });
    }
    maxHor.addEventListener('change', sendSettings);
    maxVer.addEventListener('change', sendSettings);
    smoothing.addEventListener('input', () => {
      smoothingVal.textContent = smoothing.value + '%';
      sendSettings();
    });

    // Identify
    socket.on('connect', () => {
      socket.emit('identify', { role:'admin', deviceId: null });
    });

    // client-list wie gehabt
    const clientsEl = document.getElementById('clients');
    socket.on('client-list', list => {
      clientsEl.innerHTML = '';
      list.forEach(c => {
        const li = document.createElement('li');
        const left = document.createElement('div');
        left.classList.add('left');
        const dot = document.createElement('span');
        dot.classList.add('dot');
        if (c.color) dot.style.backgroundColor = c.color;
        left.appendChild(dot);
        const info = document.createElement('span');
        info.classList.add('client-info');
        info.textContent = `${c.type} – ${c.deviceId} – ${c.ip}`;
        left.appendChild(info);
        li.appendChild(left);
        clientsEl.appendChild(li);
      });
    });

    // Gyro‑Log
    const gyroEl = document.getElementById('gyrolog');
    // store last 10 entries per device
    const gyroStore = {};
    socket.on('gyro-data', ({ deviceId, alpha, beta, gamma }) => {
      if (!gyroStore[deviceId]) gyroStore[deviceId] = [];
      const arr = gyroStore[deviceId];
      // push new, keep last 10
      arr.push({ alpha, beta, gamma, ts: Date.now() });
      if (arr.length > 10) arr.shift();

      // rebuild list
      gyroEl.innerHTML = '';
      for (let [id, entries] of Object.entries(gyroStore)) {
        entries.forEach(e => {
          const li = document.createElement('li');
          li.innerHTML = `<span class="client-info">${id}</span>
                          <span class="gyro-values">
                            α=${e.alpha.toFixed(1)}°, 
                            β=${e.beta.toFixed(1)}°, 
                            γ=${e.gamma.toFixed(1)}°
                          </span>`;
          gyroEl.appendChild(li);
        });
      }
    });
  </script>
</body>
</html>
