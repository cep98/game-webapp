<!-- game.html -->
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>LaserGame</title>
  <style>
    body { margin:0; overflow:hidden; }
    canvas { display:block; }
  </style>
</head>
<body>
<canvas id="canvas"></canvas>
<script src="/socket.io/socket.io.js"></script>
<script>
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  let w, h;
  function resize() {
    w = canvas.width = window.innerWidth;
    h = canvas.height = window.innerHeight;
  }
  window.addEventListener('resize', resize);
  resize();

  const socket = io();

  // Ball-Objekt
  const ball = { x: w/2, y: h/2, vx: 0, vy: 0, r: 20 };
  const friction = 0.99;

  // Ball-Grafik laden
  const ballImg = new Image();
  ballImg.src = '/ball.png';

  // Andere Spieler
  const clients = {};

  socket.on('gyro', data => {
    if (!clients[data.id]) {
      clients[data.id] = { alpha: data.alpha, beta: data.beta };
    } else {
      clients[data.id].alpha = data.alpha;
      clients[data.id].beta = data.beta;
    }
  });

  socket.on('disconnectClient', id => {
    delete clients[id];
  });

  socket.on('laser', data => {
    // Impuls hinzufügen
    const speed = 5;
    ball.vx += speed * Math.cos(data.angle);
    ball.vy += speed * Math.sin(data.angle);
  });

  function update() {
    ball.x += ball.vx;
    ball.y += ball.vy;

    // Kollision mit Rändern
    if (ball.x - ball.r < 0) { ball.x = ball.r; ball.vx = -ball.vx; }
    if (ball.x + ball.r > w) { ball.x = w - ball.r; ball.vx = -ball.vx; }
    if (ball.y - ball.r < 0) { ball.y = ball.r; ball.vy = -ball.vy; }
    if (ball.y + ball.r > h) { ball.y = h - ball.r; ball.vy = -ball.vy; }

    // Reibung
    ball.vx *= friction;
    ball.vy *= friction;
  }

  let lastTime = performance.now();
  function loop(now) {
    const dt = (now - lastTime) / 1000;
    lastTime = now;

    update(dt);
    ctx.clearRect(0, 0, w, h);

    // Ball zeichnen (Grafik oder Fallback-Kreis)
    if (ballImg.complete) {
      ctx.drawImage(ballImg,
        ball.x - ball.r,
        ball.y - ball.r,
        ball.r * 2,
        ball.r * 2
      );
    } else {
      ctx.fillStyle = '#f90';
      ctx.beginPath();
      ctx.arc(ball.x, ball.y, ball.r, 0, 2*Math.PI);
      ctx.fill();
    }

    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
</script>
</body>
</html>
